// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

// ===========================================
// 1. USER & AUTHENTICATION
// ===========================================

model User {
  id                Int      @id @default(autoincrement())
  name              String
  email             String   @unique
  password          String
  role              String   @default("USER") // "USER", "ADMIN"

  // --- User's Goal ---
  // The user selects a target exam (e.g., SSC CGL). 
  // This helps the UI filter content, but doesn't stop them from seeing other subjects.
  selectedCourseId  Int?
  selectedCourse    Course?  @relation(fields: [selectedCourseId], references: [id])

  // --- Activity & Progress ---
  bookmarks         Bookmark[]
  chatSessions      ChatSession[]
  learningHistories LearningHistory[]
  
  // Practice History
  quizAttempts      UserQuizAttempt[]
  flashcardStudies  UserFlashcardStudy[]
  
  // Full Mock Exam History (For detailed analysis/graphs)
  mockTestAttempts  MockTestAttempt[]

  createdAt         DateTime @default(now())
}

model Bookmark {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  url         String
  image       String?
  publishedAt DateTime?
  source      String?
  createdAt   DateTime  @default(now())
}

// ===========================================
// 2. COURSE, SYLLABUS & EXAM PATTERN
// ===========================================

// Represents a target exam (e.g., "SSC CGL Tier 1", "UPSC CSE")
model Course {
  id          Int             @id @default(autoincrement())
  name        String          @unique
  description String?
  
  // A course is made up of multiple subjects with specific rules
  subjects    CourseSubject[] 
  
  // Full length mock tests designed specifically for this course
  mockTests   MockTest[]
  
  // Users who are targeting this course
  users       User[]
}

// Global list of subjects (e.g., "History", "Reasoning", "English")
// These exist independently of courses.
model Subject {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  chapters      Chapter[]
  topics        Topic[]
  
  // This relation shows which courses this subject belongs to.
  // If this is empty, the subject is "General" and belongs to no specific course.
  courseConfigs CourseSubject[] 
}
model Chapter {
  id        Int      @id @default(autoincrement())
  name      String
  
  subjectId Int
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  topics    Topic[]

  @@unique([subjectId, name]) // Prevent duplicate chapter names within the same subject
}

// Junction Table: Defines Exam Rules for a Subject inside a Course
// Example: In "SSC CGL", "Reasoning" has 25 Questions, 2.0 Marks, 0.5 Negative.
model CourseSubject {
  id            Int     @id @default(autoincrement())
  courseId      Int
  course        Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  subjectId     Int
  subject       Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // --- Exam Pattern Rules ---
  questionCount Int     // How many questions from this subject appear in the exam?
  marksPerQ     Float   @default(1.0) // Marks awarded for a correct answer
  negativeMarks Float   @default(0.0) // Marks deducted for a wrong answer
  orderIndex    Int     @default(1)   // Order in the exam paper (e.g., 1=Reasoning, 2=GK)

  @@unique([courseId, subjectId]) // Prevents adding the same subject twice to one course
}

// Detailed Topics (e.g., "Mughal Empire", "Blood Relations")
model Topic {
  id           Int               @id @default(autoincrement())
  name         String
  
  subjectId    Int
  subject      Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // --- NEW: Optional link to a Chapter ---
  chapterId    Int?
  chapter      Chapter?          @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  
  // ... (Keep content, learnedBy, etc. as is)
  content      ContentBlock[]
  learnedBy    LearningHistory[]
  chatSessions ChatSession[]
  quizzes      Quiz[] 
  flashcards   Flashcard[]
  questions    QuestionBank[]
}

// Knowledge base for RAG (Retrieval Augmented Generation)
model ContentBlock {
  id        Int    @id @default(autoincrement())
  content   String @db.Text
  topicId   Int
  topic     Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  
  // Metadata for AI generation
  source    String? // e.g. "Previous Year Paper 2022", "The Hindu Editorial"
  
  // Embedding vector for AI Search
  vector    Unsupported("vector(1536)")?
}

// Tracks if a user has marked a topic as "Learned"
model LearningHistory {
  id         Int     @id @default(autoincrement())
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  topic      Topic   @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId    Int
  hasLearned Boolean @default(true)

  @@unique([userId, topicId])
}

// ===========================================
// 3. CENTRAL QUESTION BANK & MOCK TESTS
// ===========================================

// A repository of all questions (PYQs, AI generated, etc.)
model QuestionBank {
  id             Int      @id @default(autoincrement())
  topicId        Int
  topic          Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  
  type           String   @default("MCQ") // MCQ, TRUE_FALSE
  difficulty     String   @default("MEDIUM") // EASY, MEDIUM, HARD
  
  questionText   String   @db.Text
  options        Json     // ["A", "B", "C", "D"]
  correctIndex   Int      // 0-3
  explanation    String?  @db.Text // Detailed solution for review
  
  // Tracks where this question has been used
  usedInMocks    MockTestQuestion[]
  mockAnswers    MockTestAnswer[]
  
  // For Analytics: We can add fields like "totalAttempts", "accuracyRate" later to see how hard a question is.
  createdAt      DateTime @default(now())
}

// Represents a generated Full Exam (e.g., "SSC CGL - Mock Test 5")
model MockTest {
  id          Int      @id @default(autoincrement())
  title       String   
  courseId    Int
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  durationMin Int      @default(60) // e.g. 60 minutes
  totalMarks  Int
  isLive      Boolean  @default(false) // If true, available to users
  
  questions   MockTestQuestion[]
  attempts    MockTestAttempt[]
  
  createdAt   DateTime @default(now())
}

// Connects a Question to a Mock Test with specific marks settings
model MockTestQuestion {
  id          Int          @id @default(autoincrement())
  mockTestId  Int
  mockTest    MockTest     @relation(fields: [mockTestId], references: [id], onDelete: Cascade)
  
  questionId  Int
  question    QuestionBank @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // Snapshot of marks (because marks might change per exam type)
  marks       Float
  negative    Float
  
  @@index([mockTestId])
}

// ===========================================
// 4. ANALYTICS & RESULTS
// ===========================================

// Stores the summary of a User's attempt at a full Mock Test
model MockTestAttempt {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mockTestId    Int
  mockTest      MockTest @relation(fields: [mockTestId], references: [id], onDelete: Cascade)
  
  // High-level Stats for Graphs
  score         Float
  timeTaken     Int      // Total seconds used
  correctCount  Int
  wrongCount    Int
  skippedCount  Int
  
  // Advanced AI Analysis (JSON)
  // Example: { "weakTopics": ["Geometry", "Polity"], "accuracy": {"Reasoning": "90%", "English": "40%"} }
  analysisJson  Json?    
  
  // AI-Generated textual feedback (e.g., "Focus more on Trigonometry formulas...")
  aiFeedback    String?  @db.Text 
  
  submittedAt   DateTime @default(now())
  
  // Granular answers for deep diving
  answers       MockTestAnswer[]
}

// Stores exactly what the user clicked for every single question
model MockTestAnswer {
  id             Int             @id @default(autoincrement())
  attemptId      Int
  attempt        MockTestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  questionId     Int
  question       QuestionBank    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  selectedOption Int?            // Null if skipped
  isCorrect      Boolean
  timeTaken      Int?            // Seconds spent on JUST this question (for "Time Management" graphs)
}

// ===========================================
// 5. EXISTING FEATURES (Chat, News, Flashcards)
// ===========================================

model ChatSession {
  id       Int           @id @default(autoincrement())
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   Int
  topic    Topic         @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId  Int
  messages ChatMessage[]

  @@unique([userId, topicId])
}

model ChatMessage {
  id        Int         @id @default(autoincrement())
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId Int
  role      String 
  content   String      @db.Text
  createdAt DateTime    @default(now())
}

model CachedBroadcast {
  id        Int      @id @default(autoincrement())
  category  String
  language  String
  script    String   @db.Text
  articles  Json 
  updatedAt DateTime @updatedAt

  @@unique([category, language])
}

// Simple Topic Quiz (Different from Full Mock Test)
model Quiz {
  id        Int               @id @default(autoincrement())
  topic     Topic             @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId   Int
  questions Question[]
  attempts  UserQuizAttempt[]
  createdAt DateTime          @default(now())
}

model Question {
  id                 Int          @id @default(autoincrement())
  quiz               Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId             Int
  questionText       String
  options            Json 
  correctAnswerIndex Int 
  answers            UserAnswer[]
}

model UserQuizAttempt {
  id          Int          @id @default(autoincrement())
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  quiz        Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId      Int
  score       Int 
  total       Int 
  completedAt DateTime     @default(now())
  answers     UserAnswer[] 
}

model UserAnswer {
  id                  Int             @id @default(autoincrement())
  attempt             UserQuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  attemptId           Int
  question            Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId          Int
  selectedAnswerIndex Int 
  isCorrect           Boolean
}

model Flashcard {
  id          Int                  @id @default(autoincrement())
  topicId     Int
  topic       Topic                @relation(fields: [topicId], references: [id], onDelete: Cascade)
  question    String               @db.Text
  answer      String               @db.Text
  userStudies UserFlashcardStudy[]
  createdAt   DateTime             @default(now())
}

model UserFlashcardStudy {
  id           Int       @id @default(autoincrement())
  userId       Int
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcardId  Int
  flashcard    Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  strength     Int       @default(0) // 0-4 SRS Strength
  lastReviewed DateTime  @default(now())
  nextReviewAt DateTime  @default(now())

  @@unique([userId, flashcardId])
}

model EnglishDose {
  id        Int      @id @default(autoincrement())
  date      DateTime @unique @db.Date // Stores just the date (YYYY-MM-DD)
  
  // We store structured data as JSON for flexibility
  // Structure: { vocabulary: [], idiom: {}, grammar: {}, root: {}, quiz: {} }
  content   Json     
  
  createdAt DateTime @default(now())
}