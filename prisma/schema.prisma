// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

// ===========================================
// 1. USER & AUTHENTICATION
// ===========================================

model User {
  id                Int      @id @default(autoincrement())
  name              String
  email             String   @unique
  password          String
  role              String   @default("USER") // "USER", "ADMIN"

  selectedCourseId  Int?
  selectedCourse    Course?  @relation(fields: [selectedCourseId], references: [id])

  bookmarks         Bookmark[]
  chatSessions      ChatSession[]
  learningHistories LearningHistory[]
  quizAttempts      UserQuizAttempt[]
  flashcardStudies  UserFlashcardStudy[]
  mockTestAttempts  MockTestAttempt[]

  createdAt         DateTime @default(now())
}

model Bookmark {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  url         String
  image       String?
  publishedAt DateTime?
  source      String?
  createdAt   DateTime  @default(now())

  @@index([userId]) // Performance Index
}

// ===========================================
// 2. COURSE, SYLLABUS & EXAM PATTERN
// ===========================================

model Course {
  id          Int             @id @default(autoincrement())
  name        String          @unique
  description String?
  subjects    CourseSubject[] 
  mockTests   MockTest[]
  users       User[]
}

model Subject {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  chapters      Chapter[]
  topics        Topic[]
  courseConfigs CourseSubject[] 
}

model Chapter {
  id        Int      @id @default(autoincrement())
  name      String
  subjectId Int
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topics    Topic[]

  @@unique([subjectId, name])
  @@index([subjectId]) // Performance Index
}

model CourseSubject {
  id            Int     @id @default(autoincrement())
  courseId      Int
  course        Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  subjectId     Int
  subject       Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  questionCount Int     
  marksPerQ     Float   @default(1.0) 
  negativeMarks Float   @default(0.0) 
  orderIndex    Int     @default(1)   

  @@unique([courseId, subjectId])
  @@index([courseId]) // Performance Index
  @@index([subjectId]) // Performance Index
}

model Topic {
  id           Int               @id @default(autoincrement())
  name         String
  subjectId    Int
  subject      Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  chapterId    Int?
  chapter      Chapter?          @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  
  content      ContentBlock[]
  learnedBy    LearningHistory[]
  chatSessions ChatSession[]
  quizzes      Quiz[] 
  flashcards   Flashcard[]
  questions    QuestionBank[]

  @@index([subjectId]) // Performance Index
  @@index([chapterId]) // Performance Index
}

model ContentBlock {
  id        Int    @id @default(autoincrement())
  content   String @db.Text
  topicId   Int
  topic     Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  source    String?
  vector    Unsupported("vector(1536)")?

  @@index([topicId]) // Performance Index
}

model LearningHistory {
  id         Int     @id @default(autoincrement())
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  topic      Topic   @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId    Int
  hasLearned Boolean @default(true)

  @@unique([userId, topicId])
  @@index([userId]) // Performance Index
}

// ===========================================
// 3. CENTRAL QUESTION BANK & MOCK TESTS
// ===========================================

model QuestionBank {
  id             Int      @id @default(autoincrement())
  topicId        Int
  topic          Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  type           String   @default("MCQ") 
  difficulty     String   @default("MEDIUM") 
  questionText   String   @db.Text
  options        Json     
  correctIndex   Int      
  explanation    String?  @db.Text 
  
  usedInMocks    MockTestQuestion[]
  mockAnswers    MockTestAnswer[]
  createdAt      DateTime @default(now())

  @@index([topicId]) // Performance Index
}

model MockTest {
  id          Int      @id @default(autoincrement())
  title       String   
  courseId    Int
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  durationMin Int      @default(60) 
  totalMarks  Int
  isLive      Boolean  @default(false) 
  
  questions   MockTestQuestion[]
  attempts    MockTestAttempt[]
  createdAt   DateTime @default(now())

  @@index([courseId]) // Performance Index
}

model MockTestQuestion {
  id          Int          @id @default(autoincrement())
  mockTestId  Int
  mockTest    MockTest     @relation(fields: [mockTestId], references: [id], onDelete: Cascade)
  questionId  Int
  question    QuestionBank @relation(fields: [questionId], references: [id], onDelete: Cascade)
  marks       Float
  negative    Float
  
  @@index([mockTestId]) 
  @@index([questionId]) // Performance Index
}

// ===========================================
// 4. ANALYTICS & RESULTS
// ===========================================

model MockTestAttempt {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mockTestId    Int
  mockTest      MockTest @relation(fields: [mockTestId], references: [id], onDelete: Cascade)
  
  score         Float
  timeTaken     Int      
  correctCount  Int
  wrongCount    Int
  warningCount  Int      @default(0)
  skippedCount  Int
  analysisJson  Json?    
  aiFeedback    String?  @db.Text 
  submittedAt   DateTime @default(now())
  answers       MockTestAnswer[]

  @@index([userId]) // Performance Index
  @@index([mockTestId]) // Performance Index
}

model MockTestAnswer {
  id             Int             @id @default(autoincrement())
  attemptId      Int
  attempt        MockTestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId     Int
  question       QuestionBank    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  selectedOption Int?            
  isCorrect      Boolean
  timeTaken      Int?            

  @@index([attemptId]) // Performance Index
  @@index([questionId]) // Performance Index
}

// ===========================================
// 5. EXISTING FEATURES
// ===========================================

model ChatSession {
  id       Int           @id @default(autoincrement())
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   Int
  topic    Topic         @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId  Int
  messages ChatMessage[]

  @@unique([userId, topicId])
  @@index([userId]) // Performance Index
}

model ChatMessage {
  id        Int         @id @default(autoincrement())
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId Int
  role      String 
  content   String      @db.Text
  imageUrl  String?
  createdAt DateTime    @default(now())

  @@index([sessionId]) // Performance Index
}

model CachedBroadcast {
  id        Int      @id @default(autoincrement())
  category  String
  language  String
  script    String   @db.Text
  articles  Json 
  updatedAt DateTime @updatedAt

  @@unique([category, language])
}

model Quiz {
  id        Int               @id @default(autoincrement())
  topic     Topic             @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId   Int
  questions Question[]
  attempts  UserQuizAttempt[]
  createdAt DateTime          @default(now())
  
  @@index([topicId])
}

model Question {
  id                 Int          @id @default(autoincrement())
  quiz               Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId             Int
  questionText       String
  options            Json 
  correctAnswerIndex Int 
  answers            UserAnswer[]

  @@index([quizId])
}

model UserQuizAttempt {
  id          Int          @id @default(autoincrement())
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  quiz        Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId      Int
  score       Int 
  total       Int 
  completedAt DateTime     @default(now())
  answers     UserAnswer[] 

  @@index([userId])
  @@index([quizId])
}

model UserAnswer {
  id                  Int             @id @default(autoincrement())
  attempt             UserQuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  attemptId           Int
  question            Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId          Int
  selectedAnswerIndex Int 
  isCorrect           Boolean

  @@index([attemptId])
  @@index([questionId])
}

model Flashcard {
  id          Int                  @id @default(autoincrement())
  topicId     Int
  topic       Topic                @relation(fields: [topicId], references: [id], onDelete: Cascade)
  question    String               @db.Text
  answer      String               @db.Text
  userStudies UserFlashcardStudy[]
  createdAt   DateTime             @default(now())

  @@index([topicId])
}

model UserFlashcardStudy {
  id           Int       @id @default(autoincrement())
  userId       Int
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcardId  Int
  flashcard    Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  strength     Int       @default(0) // 0-4 SRS Strength
  lastReviewed DateTime  @default(now())
  nextReviewAt DateTime  @default(now())

  @@unique([userId, flashcardId])
  @@index([userId])
}

model EnglishDose {
  id        Int      @id @default(autoincrement())
  date      DateTime @unique @db.Date 
  content   Json     
  createdAt DateTime @default(now())
}